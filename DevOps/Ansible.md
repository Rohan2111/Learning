<img src="https://logowik.com/content/uploads/images/ansible3554.jpg" width=500px style="position:relative; left:32%;" >

<br>
<br>

# What is Ansbile?
Ansible is an open source IT automation engine that automates provisioning, configuration management, application deployment, orchestration, and many other IT processes. It is free to use, and the project benefits from the experience and intelligence of its thousands of contributors. Ansible provides automation that reduces complexity and runs everywhere. Using Ansible lets you automate virtually any task.

<br>
<br>

# Here are some common use cases for Ansible:
- Eliminate repetition and simplify workflows
- Manage and maintain system configuration
- Continuously deploy complex software
- Perform zero-downtime rolling updates

<br>
<br>

# Advantage of using Ansible:
- Simple and easy to use: Ansible use a simple easy-to-learn language (YAML) to define playbooks, which makes it easy for anyone to use, even those with little or no programming experience.
- Agent-less architecture: Ansible does not require any agents to be installed on remote systems, which makes it easy to set up and use.
- Configuration Management: Ansible can be used to automate configuration management tasks such as provisioning, application deployment, and infrastructure management.
- Scalability: Ansible can manage a large number of systems simultaneously, making it ideal for large-scale deployments.
- Ansbile playbooks can be run multiple times without changing the system state.
- Open-Source: Ansible is an open-source tool, which means it is free to use and has a large community of contributors who regularly contribute to its development.
- Integration with others tools: Ansible can be integrated with other tools such as Docker, Kubernetes, and AWS, which makes it versatile and easy to use in a variety of environments.

<br>
<br>

# Ansible's Three Major Components
- Modules
  - Description: Modules are the units of work in Ansible. They are scripts that perform specific tasks such as installing software, managing services, or handling files.
  - Usage: Modules can be executed individually via the ansible command or used within playbooks for more complex automation tasks.
  - Examples: apt (for package management), service (for managing services), copy (for copying files).

- Playbooks
  - Description: Playbooks are YAML files that define a series of tasks to be executed on managed nodes. They describe the desired state of a system and the steps needed to achieve that state.
  - Usage: Playbooks allow for complex configurations and orchestrations, chaining multiple tasks and applying them to groups of hosts.
  - Examples: Installing a web server, configuring a database, deploying an application.

- Inventories
  - Description: Inventories are files that list the managed nodes (hosts) and group them for easier management. They define which systems Ansible will target.
    - Usage: Inventories can be static (a simple list of IP addresses or hostnames) or dynamic (generated by scripts or cloud plugins to reflect the current infrastructure).
  - Examples: A list of web servers, database servers, and load balancers, grouped by their roles.

<br>
<br>

# Uses
YAML: For writing configuration files because it's easy to read, write and understand.

<br>

# Installation of Ansible
- Ubuntu/Debian
```
https://docs.ansible.com/ansible/latest/installation_guide/index.html

$ sudo apt update
$ sudo apt install software-properties-common
$ sudo add-apt-repository --yes --update ppa:ansible/ansible
$ sudo apt install ansible -y
$ ansible --version
$ ansible localhost -m ping                                     # To check ansible running perfect on your server
```

- Install ansible through python
```
# Use pip in your selected Python environment to install the full Ansible package
$ python3 -m pip install ansible

# To Upgrading Ansible
$ python3 -m pip install --upgrade ansible
```

- Create ansible directory
  - Create the (`/etc/ansible`) directory
    - sudo mkdir -p /etc/ansible

- Create a Default Inventory File
  - Create a default inventory file (`hosts`)
    - sudo touch /etc/ansible/hosts

- Create a Default Configuration File
  - Create a default configuration file (`ansible.cfg`)
    - sudo touch /etc/ansible/ansible.cfg

- Set Up Basic Configuration
  - Add some basic configuration to the `ansible.cfg` file. Open the file in a text editor
    - sudo nano /etc/ansible/ansible.cfg
  
  - Add the following content:
    - [defaults]
      inventory = /etc/ansible/hosts
      remote_user = your_username                                  # Replace `your_username` with your actual username.
      host_key_checking = False

  - Or run this command
    - ansible-config init --disabled -t all > ansible.cfg

- Populate the Inventory File
  - Edit the inventory file to add your hosts. Open the hosts file in a text editor:
    - sudo nano /etc/ansible/hosts
  
  - Add your hosts:
    - [webservers]
      192.168.1.10
      192.168.1.11

      [dbservers]
      192.168.1.20
      192.168.1.21

- Verify Installation
  - Run a simple Ansible command to verify that the setup works:
    - ansible all -m ping

<br>
<br>

# Creating our first Playbook
- Create YAML file for playbook (file_name.yml). Simple Playbook
```
---

- name: First Basic Playbook
  hosts: localhost

  tasks:
  - name: Test Connectivity
    ping:
```

- Run this playbook with this command
```
$ ansible-playbook {file_name}
```

- If you want to check the yaml file indentation or errors
```
$ ansible-playbook --syntax-check {file_name}
```

- Multiple task playbook
```
---

- name: First Basic Playbook
  hosts: localhost

  tasks:
  - name: Test Connectivity
    ping:
  
  - name: "Print Output"
    debug: msg="Alright!!"
```

<br>
<br>

# Playbook for installing and Starting a Package
- Installing Nginx package
```
---

# This playbook is named "Install and Start the service"
- name: Install and Start the service
  
  # Specifies that the playbook will run on the localhost
  hosts: localhost

  # Defines the list of tasks to be executed
  tasks:

    # Task Name (Installing nginx)
  - name: Installing nginx
  
    # Uses the 'apt' module to manage package installation
    apt:
   
      # The name of the package to be installed
      name: nginx
   
      # Ensures that the package is present on the system
      state: present

  # Task Name (Starting the nginx service)
  - name: Starting the nginx service
   
    # Uses the 'service' module to manage services
    service:
   
      # The name of the service to be managed
      name: nginx
    
      # Ensures that the service is started
      state: started
    
      # Ensures that the service is enabled to start at boot
      enabled: true
```

<br>
<br>

# Overview of Ansible Playbook
```
---

- name: Install and Start Nginx
  hosts: webservers                             # Assuming `Webserver` is defined to your Ansible Inventory
  become: true                                  # Tasks should be run with sudo privileges

  tasks:
  - name: Install Nginx
    apt:                                        # Using the `apt` module for package manage module for package
      name: nginx                               # Name of the package
      state: present                            # Ensure the package is installed
  
  - name: Start Nginx
    service:                                    # Using the serivce module to manage the service
      name: nginx
      state: started
      enable: true                              # Ensure Nginx is enabled to start on boot
```

<br>
<br>

# Playbook for Remote Server
- Insert your remote server IP address in `/etc/ansible/hosts` file
  - Ungrouped Hosts
```
$ nano /etc/ansible/hosts

192.168.1.2

```

- Grouped Hosts
```
$ nano /etc/ansible/hosts

[webserver]
192.168.1.3
192.168.1.4
rohan.example.com
```

- To check hosts file properly working
```
$ ansible-inventory --list
```

- Checks connectivity to all hosts in the inventory
```
$ ansible all -m ping -u root
```

<br>
<br>

# Installing app on remote server
```
# Put your remote IP address in {Hosts} file first


---

- name: Install and Start the serivce
  hosts: all             # write all to install on provided IP in hosts file

  tasks:
  - name: Installing nginx
    apt:
      name: nginx
      state: present

  - name: Starting the nginx serivce
    service:
      name: nginx
      state: started
      enabled: true
```

<br>
<br>

# Copy file Remote Server
- Copy file Source to Destination
```
---

- name: Copying files to remote
  hosts: all

  tasks:
  - name: Copy files
    copy:
      src: /etc/ansible/playbooks/myfile.txt
      dest: /tmp
```

- Changing Owner and Group while coping
```
---

- name: Copying files to remote
  hosts: all

  tasks:
  - name: Copy files
    copy:
      src: /etc/ansible/playbooks/myfile.txt
      dest: /tmp
      owner: rohan                                 # This owner already exist on the server
      group: rohan                                 # This group already exist on the server
```

- Changing Permission of file
```
---

- name: Copying files to remote
  hosts: all

  tasks:
  - name: Copy files
    copy:
      src: /etc/ansible/playbooks/myfile.txt
      dest: /tmp
      owner: rohan
      group: rohan
      mode: 0755 or u=rwx,g=rw,o=r                 # Adding this syntax to changing permission of your file while copying
```

<br>
<br>

# Taking Backup of Files
- Adding Backup syntax in the file
```
---

- name: Copying files to remote
  hosts: all

  tasks:
  - name: Copy files
    copy:
      src: /etc/ansible/playbooks/myfile.txt
      dest: /tmp
      owner: rohan
      group: rohan
      mode: 0755 or u=rwx,g=rw,o=r
      backup: true                                # Adding this syntax to take backup of your old file
```

<br>
<br>

# Ansible File Module
- Creating a file on remote server
```
---

- name: File Module
  hosts: all

  tasks:
  - name: Creating a file
    file:
      path: /tmp/newfile.txt
      state: touch
      owner: rohan
      group: rohan
      mode: u=rwx,g=rw,o=r
```

- Deleting a file on remote server
```
---

- name: File Module
  hosts: all

  tasks:
  - name: Delete a file
    file:
      path: /tmp/newfile.txt
      state: absent                                   # Write {absent} in state syntax
```

- Creating a folder on remote server
```
---

- name: File Module
  hosts: all

  tasks:
  - name: Creating a Directory
    file:
      path: /tmp/myfolder
      state: directory
```

- Deleting a folder on remote server
```
---

- name: File Module
  hosts: all

  tasks:
  - name: Delete a file
    file:
      path: /tmp/myfolde
      state: absent                                   # Write {absent} in state syntax
```

- Permission change in Existing file on remote server
```
---

- name: Change Permission
  hosts: all

  tasks:
  - name: Change Permission of existing file
    file:
      path: /tmp/newfile.txt
      mode: 0755
```

<br>
<br>

# Run a Script on Remote
- Use shell syntax
```
---

- name: Run a script
  hosts: all

  tasks:
  - name: Run Script
    shell: ./script.sh >> test.log
    args:
      chdir: /tmp/script/
      creates: test.log
```

<br>
<br>

# Creating Cron Job
- Adding Cron Job on Remote Server
```
---

- name: Cron Setup
  hosts: all

  tasks:
  - name: Add Cron Job
    cron:
      name: Run Test Script
      minute: 30
      hour: 18
      day: 15
      month: "*"
      weekday: "*"
      user: rohan
      job: /tmp/script/script.sh
```

- To Remove Cron Jon on Remote Server
```
---

- name: Modify Cron
  hosts: all

  tasks:
  - name: Remove Cron Job
    cron:
      name: Run Test Script                   # Provide exact same name which you provide on adding cron job
      state: absent
      user: rohan
```

- Disbale Cron Job on Remote Server
```
---

- name: Cron Setup
  hosts: all

  tasks:
  - name: Add Cron Job
    cron:
      name: Run Test Script
      minute: 30
      hour: 18
      day: 15
      month: "*"
      weekday: "*"
      user: rohan
      job: /tmp/script/script.sh
      disabled: yes                         # Use disbaled syntax
```

- To set environment variable in cron job
```
---

- name: Modify Cron
  hosts: all

  tasks:
  - name: Set environment variable
    cron:
      name: {name}
      env: yes
      user: {username}
      job: /tmp/script/test.sh
      insertbefore: script
            or
      insertafter: script
      state: absent                         # If you want to remove
```

<br>
<br>

# Creating User on Remote Server
- Add New User
```
---

- name: User Management
  hosts: all

  tasks:
  - name: User Creation
    user:
      name: rohan
      comment: New user adding            # Optional
      home: /home/rohan
      shell: /bin/bash
      groups: IT,rohan
```

- Delete User
```
---

- name: User Management
  hosts: all

  tasks:
  - name: Delete user
    user:
      name: rohan
      groups: IT,rohan
      state: absent
      remove: yes                             # Remove home directory also
```

<br>
<br>

# Add/Update Password
- Create user password
```
---

- name: Set Password
  hosts: all

  tasks:
  - name: Set Password
    user:
      name: rohan
      update_password: always
      password: "{{'12345' | password_hash('sha512')}}"
```

<br>
<br>

# Find and Stop Process
- Find the process then kill it and again started
```
---

- name: Kill a process
  hosts: all

  tasks:
  - name: Find a process and kill it
    ignore_errors: yes
    shell: "pgrep nginx | xargs kill"

  - name: Start the service
    service:
      name: nginx
      state: started
```

<br>
<br>

# Download File From Internet
```
---

- name: Download files
  hosts: all

  tasks:
  - name: Download file
    get_url:
      url: https://github.com/slackhq/nebula/releases/download/v1.9.3/nebula-linux-amd64.tar.gz
      dest: /tmp/nebula
      owner: rohan
      group: rohan
      mode: 0775
```

<br>
<br>

# Enable Firewall Service or Port
```
---

- name: Firewall Changes
  hosts: all

  tasks:
  - name: Enable a service in firewalld
    firewalld:
      port: 80/tcp
      permanent: true
      state: enabled
  
  - name: Reload the firewalld
    service:
      name: firewalld
      state: reloaded
```

<br>
<br>

# Run Playbook with Sudo User
- Firstly add become: true in every playbook
```
- name: Firewall Changes
  hosts: all
  become: true

$ ansbile-playbook --ask-become-password {playbook.yml file}        # To ask sudo password of remote server to execute your playbook file
```

<br>
<br>

# Task with Ansible Commands
- Ansible Ad Hoc tasks are one-time commands run directly from the command line, without the need for a playbook. They are useful for quick, on-the-fly automation tasks.
```
# ansbile {host-pattern} -m {module} -a "{module arguments}" -u {username} -b
$ ansbile myserver -m command -a "df -h"
```

- Ping Server's
```
$ ansible 192.168.10.1 -m ping
$ ansible myservers -m ping                                         # Ping groups of server's given in a host file
```

- Copy files through ansible
```
$ ansible 192.168.10.1 -m copy -a "src=/path/of/file dest=/path/of/folder" -b --ask-become-pass
```

- Copy file with permisson change
```
$ ansible 192.168.10.1 -m copy -a "src=/path/of/file dest=/path/of/folder mode=0777" -b --ask-become-pass
```

- Service restart on remote server
```
$ ansible 192.168.10.1 -m service -a "name=nginx state=reloaded"
```

- Run script on remote server
```
$ ansible all -m shell -a /tmp/script/test.sh"
```

- Run command on remote server
```
$ ansible all -m command -a "df -h"
```

- Install package on remote server
```
$ ansible all -m apt -a "name=vim state=present"
```

<br>
<br>

# Tags in Ansible
- Tags in Ansible are used to selectively run specific tasks or groups of tasks within a playbook, providing greater control and flexibility in executing parts of the automation process.
```
---
- name: Install and Start the service
  hosts: all

  tasks:
  - name: Installing Nginx
    apt:
      name: nginx
      state: present
    tags: i-nginx                                               # Tag name

  - name: Starting the nginx service
    service:
      name: nginx
      state: started
      enabled: true
    tags: ss-nginx                                              # Tag name

# Find tags in playbook
$ ansible-playbook <playbook_name> --list-tags

# Call and Run tasks through tags
$ ansible-playbook <playbook_name> -t <tag_nam>

# All tags run accept one or more tasks
$ ansible-playbook <playbook_name> --skip-tags <tag_name>
```

<br>
<br>

# Variables in Ansible
- Variables in Ansible are used to store values that can be reused and dynamically referenced throughout playbooks, roles, and templates, allowing for more flexible and manageable automation.
```
---
- name: Install and Start the service
  hosts: all
  vars:                                                         # Variables Syntax
  - app : nginx

  tasks:
  - name: Installing nginx
    apt:
      name: "{{ app }}"                                         # Variable Declare
      state: present
    
  - name: Starting the nginx service
    service:
      name: "{{ app }}"                                         # Variable Declare
      state: started
      enabled: true
```

- Variable in hosts file
```
$ nano hosts

ServerA ansible_host=192.168.10.1
```

<br>
<br>

# Handlers in Ansible
- Handlers in Ansible are special tasks triggered by other tasks using the `notify` directive, often used for actions like restarting services when a change occurs.
```
---
- name: Firewall Changes
  hosts: all

  tasks:
  - name: Enable a Service in Firewalld
    firewalld:
      port: 80/tcp
      permanent: true
      state: enabled
    notify:                                             # Use notify syntax to trigger handler
    - Reload firewalld

  handlers:                                             # Write handlers to trigger special task
  - name: Reload firewalld
    service:
      name: firewalld
      state: reloaded
```

<br>
<br>

# Conditions in Ansible
- Conditions in Ansible are used to control task execution based on certain criteria, typically using the `when` directive to specify the condition under which a task should run.
```
# If you want to know about everything for your remote server
$ ansible 192.168.10.1 -m setup

---
- name: Installing HTTPD
  hosts: all

  tasks:
  - name: Install httpd on RedHat server
    yum:
      name: httpd
      state: present
    when: ansible_os_family == "RedHat"

  - name: Install httpd on Ubuntu server
    apt:
      name: apache2
      state: present
    when: ansible_os_family == "Ubuntu"
```

<br>
<br>

# Loops in Ansible
- Loops in Ansible allow tasks to be executed multiple times with different items or sets of parameters, providing efficient iteration over lists and dictionaries.

- Through Loops Syntax
```
---

- name: User Management
  hosts: all

  tasks:
  - name: User Creation
    user:
      name: "{{ item }}"
      comment: new user adding for QA Team
      shell: /bin/bash
    loop:
      - raju
      - sham
      - baburao
```

- Through Variables Syntax
```
---

- name: Install and Start the service
  hosts: all
  vars:
    - apps: [vim,apache2,telnet,ncdu]

  tasks:
  - name: Installing packages
    apt:
      name: "{{ item }}"
      state: present
    with_items: "{{ apps }}"
```

<br>
<br>

# Ansible Roles
- An ansible role is a structured way of grouping together various functionalities and making it easier to reuse and share common setup tasks.

- Use Case
  - Install apache httpd webserver on remote server
  - Place our custom HTML file to use
  - Start the service
  - Enable service in Firewall
  - Reload the Firewall

- Initialsed roles folder for playbook
```
$ ansible-galaxy init <folder_name>
```